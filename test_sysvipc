#!/usr/bin/env ruby
#
#    $Source$
#
#    $Revision$
#    $Date$
#
#    Copyright (c) 2006 James Steven Jenkins.
#

require 'sysvipc'
require 'test/unit'

include SystemVIPC

KEY = ftok(__FILE__, 0)

NSEMS = 16

class TestCradle < Test::Unit::TestCase

  def setup
  end

  def test_msg
  end

  def test_sem

    sem = Semaphore.new(KEY, NSEMS, IPC_CREAT | 0660)
    assert Semaphore === sem

    assert sem.size == NSEMS

    NSEMS.times do |i|
      assert Semaphore === sem.set_value(i, 2)
      assert 2 == sem.value(i)
    end

    values = Array.new(NSEMS, 1)
    assert Semaphore === sem.set_all(values)
    assert values == sem.to_a

    pid = Process.pid
    NSEMS.times do |i|
      assert pid == sem.pid(i)
      assert 0 == sem.n_count(i)
      assert 0 == sem.z_count(i)
    end

    acquire = []
    release = []
    NSEMS.times do |i|
      op = SemaphoreOperation.new(i, -1)
      assert i == op.pos
      assert -1 == op.value
      assert 0 == op.flags
      acquire << op

      op = SemaphoreOperation.new(i, 1)
      assert i == op.pos
      assert 1 == op.value
      assert 0 == op.flags
      release << op
    end

    assert Semaphore === sem.apply(acquire)
    assert Semaphore === sem.apply(release)

    sem.remove

  end

  def test_shm
  end

  def teardown
  end

end
